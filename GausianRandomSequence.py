import matplotlib.pyplot as plt
import numpy as np
import scipy.stats as stats
import math
import VirtualDoubleCoverage
from VirtualDoubleCoverage import *
import random
import NetworkFlow
from NetworkFlow import *
points = 0


def metric(a, b):
    # a = 0 if not a else a % points
    # b = 0 if not b else b % points
    d = abs(b-a)  # % points
    if d > points//2:
        return points-d
    return d


n = 20
k = 10
points = n
for t in range(5):
    print("\nTEST: ", t)
    r = np.random.normal(loc=10, scale=1, size=pow(n,2))
    # print(r)
    sequence = [round(e) for e in r]
    # sequence=#[i if i> 0 and i <= n else n for i in sequence]
    # sequence=[10, 12, 10, 9, 8, 9, 11, 10, 10, 11, 9, 10, 11, 11, 10, 10, 9, 10, 8, 10, 9, 11, 9, 10, 9, 10, 10, 10, 10, 9, 11, 10, 9, 10, 10, 10, 10, 9, 11, 12, 9, 10, 12, 10, 10, 10, 11, 11, 13, 10, 8, 10, 10, 10, 12, 10, 10, 11, 10, 8, 10, 9, 10, 11, 9, 9, 11, 11, 9, 10, 9, 11, 9, 10, 10, 10, 10, 10, 10, 10, 9, 9, 10, 11, 11, 9, 10, 12, 10, 13, 9, 9, 11, 11, 10, 10, 12, 12, 9, 10, 9, 10, 10, 10, 10, 9, 11, 12, 11, 8, 12, 9, 10, 10, 9, 8, 11, 11, 11, 9, 10, 8, 11, 12, 10, 9, 11, 11, 10, 9, 9, 9, 9, 10, 11, 10, 9, 8, 10, 10, 8, 11, 8, 8, 10, 9, 9, 9, 10, 10]
    # sequence=[10, 9, 11, 9, 11, 10, 9, 10, 10, 9, 9, 8, 8, 10, 9, 11, 10, 11, 12, 10, 10, 11, 10, 11, 8, 9, 10, 10, 10, 11, 11, 11, 10, 8, 9, 9, 13, 9, 8, 9, 10, 10, 10, 10, 10, 9, 9, 9, 10, 9, 7, 10, 10, 8, 11, 10, 8, 10, 10, 10, 9, 9, 10, 9, 10, 8, 8, 9, 11, 10, 8, 10, 8, 10, 11, 10, 9, 9, 11, 11, 9, 9, 11, 10, 10, 9, 10, 13, 11, 9, 10, 10, 10, 9, 10, 11, 9, 10, 10, 10, 10, 9, 9, 9, 11, 11, 10, 9, 9, 10, 10, 9, 10, 11, 9, 10, 10, 10, 11, 10, 10, 8, 10, 11, 11, 9, 11, 9, 9, 10, 11, 9, 12, 10, 10, 9, 10, 10, 10, 11, 9, 10, 7, 10, 9, 8, 9, 9, 11, 11]
    # sequence=[10, 12, 10, 9, 8, 9, 11, 10, 10, 11, 9, 10, 11, 11, 10, 10, 9, 10, 8, 10, 9, 11, 9, 10, 9, 10, 10, 10, 10, 9, 11, 10, 9, 10, 10, 10, 10, 9, 11, 12, 9, 10, 12, 10, 10, 10, 11, 11, 13, 10, 8, 10, 10, 10, 12, 10, 10, 11, 10, 8, 10, 9, 10, 11, 9, 9, 11, 11, 9, 10, 9, 11, 9, 10, 10, 10, 10, 10, 10, 10, 9, 9, 10, 11, 11, 9, 10, 12, 10, 13, 9, 9, 11, 11, 10, 10, 12, 12, 9, 10, 9, 10, 10, 10, 10, 9, 11, 12, 11, 8, 12, 9, 10, 10, 9, 8, 11, 11, 11, 9, 10, 8, 11, 12, 10, 9, 11, 11, 10, 9, 9, 9, 9, 10, 11, 10, 9, 8, 10, 10, 8, 11, 8, 8, 10, 9, 9, 9, 10, 10]
    # sequence=[9, 12, 11, 10, 10, 10, 11, 10, 8, 10, 10, 11, 11, 10, 11, 8, 10, 9, 9, 10, 9, 11, 9, 10, 11, 10, 10, 9, 9, 12, 10, 9, 9, 9, 9, 10, 13, 12, 10, 9, 11, 9, 10, 10, 10, 11, 8, 9, 10, 10, 11, 11, 11, 10, 10, 10, 11, 9, 9, 10, 10, 10, 11, 11, 9, 10, 12, 11, 10, 10, 9, 8, 9, 10, 8, 9, 11, 10, 10, 10, 8, 11, 8, 11, 10, 11, 11, 11, 8, 10, 10, 11, 9, 9, 10, 11, 11, 9, 12, 9, 9, 10, 9, 10, 9, 10, 10, 7, 8, 10, 11, 11, 9, 8, 11, 10, 10, 8, 10, 12, 11, 11, 11, 10, 10, 11, 10, 10, 11, 11, 11, 9, 10, 8, 9, 12, 10, 10, 9, 12, 10, 11, 9, 11, 11, 11, 12, 10, 10, 10]
    # sequence=[12, 11, 9, 9, 11, 10, 9, 10, 9, 11, 11, 10, 10, 9, 9, 10, 11, 10, 11, 12, 11, 9, 10, 9, 10, 9, 11, 11, 10, 8, 10, 10, 11, 9, 11, 11, 10, 9, 12, 10, 11, 9, 10, 9, 12, 10, 10, 11, 9, 11, 12, 11, 10, 10, 9, 9, 10, 9, 10, 11, 10, 10, 11, 8, 10, 9, 10, 10, 11, 10, 8, 11, 9, 11, 9, 10, 9, 10, 11, 11, 8, 10, 11, 10, 10, 9, 10, 12, 9, 11, 9, 9, 9, 9, 11, 10, 11, 10, 9, 11, 11, 10, 11, 11, 11, 11, 10, 9, 9, 8, 9, 11, 10, 10, 12, 9, 10, 9, 10, 11, 10, 9, 12, 10, 9, 10, 10, 9, 11, 9, 11, 11, 10, 10, 10, 10, 12, 9, 12, 10, 12, 10, 8, 10, 10, 12, 11, 10, 10, 9, 10, 10, 9, 12, 11, 11, 10, 10, 9, 9, 11, 10, 9, 10, 10, 12, 10, 10, 9, 10, 9, 10, 11, 10, 10, 9, 9, 12, 10, 8, 10, 10, 12, 10, 10, 11, 13, 11, 10, 10, 9, 8, 10, 9, 11, 9, 10, 8, 10, 9]
    # sequence = [10, 11, 11, 9, 11, 10, 10, 11, 10, 9, 13, 10, 9, 10, 11, 11, 9, 9, 10, 11, 9, 12, 10, 9, 10, 11, 9, 8, 10, 10, 10, 11, 10, 9, 9, 9, 10, 8, 11, 10, 11, 12, 11, 11, 9, 10, 11, 10, 9, 10, 10, 8, 13, 9, 9, 12, 9, 11, 9, 10, 10, 9, 9, 10, 10, 9, 10, 9, 10, 9, 10, 10, 9, 9, 10, 9, 11, 10, 10, 9, 8, 8, 10, 9, 11, 12, 10, 10, 9, 9, 10, 9, 10, 11, 12, 11, 10, 12, 10, 9, 9, 9, 9, 9, 10, 11, 10, 10, 11, 9, 10, 9, 10, 11, 8, 10, 11, 11, 9, 10, 10, 12, 10, 11, 10, 12, 10, 10, 9, 9, 11, 10, 10, 9, 10, 10, 10, 11, 9, 9, 11, 11, 9, 10, 11, 10, 9, 10, 11,
                # 10, 10, 11, 11, 10, 10, 10, 10, 10, 9, 9, 10, 10, 11, 10, 9, 11, 9, 10, 10, 10, 9, 10, 12, 9, 10, 10, 10, 8, 11, 11, 9, 11, 10, 10, 11, 10, 9, 10, 11, 10, 11, 9, 11, 9, 10, 9, 13, 8, 10, 10, 10, 8, 12, 10, 11, 8, 9, 9, 9, 10, 12, 10, 9, 11, 12, 12, 11, 9, 11, 11, 10, 8, 9, 8, 10, 9, 10, 10, 10, 10, 11, 12, 10, 9, 10, 11, 9, 11, 8, 11, 12, 9, 9, 12, 9, 8, 9, 11, 11, 10, 8, 10, 9, 10, 8, 11, 11, 10, 10, 11, 9, 13, 11, 10, 12, 10, 11, 11, 10, 10, 10, 10, 9, 11, 10, 9, 11, 12, 9, 9, 10, 11, 10, 9, 9, 10, 11, 10, 9, 11, 11, 11, 10, 10, 9, 10, 10, 9, 10, 10]
    # sequence=[11, 9, 12, 11, 10, 10, 9, 9, 10, 10, 8, 11, 10, 10, 9, 10, 10, 11, 11, 10, 9, 12, 11, 10, 10, 9, 9, 9, 10, 11, 11, 9, 11, 9, 9, 10, 10, 9, 10, 10, 11, 10, 8, 11, 11, 9, 9, 11, 10, 11, 10, 10, 12, 11, 11, 11, 10, 10, 10, 10, 9, 9, 9, 11, 10, 11, 9, 11, 10, 11, 10, 11, 10, 11, 9, 10, 10, 12, 8, 11, 9, 9, 9, 9, 9, 11, 8, 9, 9, 10, 10, 10, 11, 11, 10, 10, 10, 9, 10, 11, 9, 11, 10, 10, 9, 10, 9, 8, 9, 10, 10, 11, 9, 10, 11, 10, 10, 9, 10, 10, 10, 10, 10, 9, 10, 11, 9, 10, 11, 10, 8, 10, 10, 10, 10, 9, 10, 11, 10, 10, 10, 7, 11, 11, 10, 11, 11, 9, 10, 10, 9, 12, 11, 9, 9, 11, 12, 10, 11, 9, 10, 9, 11, 10, 10, 12, 9, 8, 10, 10, 9, 8, 10, 12, 10, 10, 8, 10, 8, 11, 10, 10, 8, 9, 11, 12, 11, 9, 12, 9, 10, 8, 10, 10, 9, 10, 11, 11, 9, 12, 8, 9, 9, 10, 11, 12, 10, 11, 12, 9, 11, 11, 10, 12, 10, 9, 8, 11, 9, 9, 10, 12, 8, 10, 10, 9, 10, 11, 10, 9, 11, 9, 10, 10, 11, 11, 10, 9, 8, 9, 10, 10, 11, 10, 10, 11, 11, 11, 11, 10, 13, 10, 9, 8, 9, 11, 9, 9, 11, 8, 9, 9, 11, 9, 10, 10, 10, 10, 9, 10, 12, 10, 10, 10, 10, 10, 9, 9, 11, 10, 9, 9, 9, 10, 9, 10, 10, 9, 8, 9, 8, 9, 9, 11, 10, 10, 10, 11, 8, 11]
    # sequence=[9, 10, 9, 10, 12, 11, 9, 9, 9, 9, 11, 10, 8, 11, 9, 9, 10, 9, 11, 10, 11, 10, 11, 11, 10, 10, 10, 11, 10, 9, 9, 10, 9, 9, 11, 10, 13, 11, 9, 10, 11, 9, 9, 11, 12, 9, 9, 11, 11, 10, 11, 11, 8, 11, 12, 10, 8, 12, 9, 9, 13, 10, 10, 10, 10, 11, 10, 11, 11, 10, 8, 10, 11, 10, 11, 10, 9, 11, 11, 10, 9, 12, 10, 10, 11, 11, 11, 10, 9, 11, 10, 9, 8, 13, 11, 11, 10, 10, 10, 10, 10, 10, 9, 9, 9, 12, 11, 10, 12, 10, 9, 10, 9, 11, 11, 11, 10, 12, 11, 9, 10, 12, 10, 12, 9, 12, 12, 10, 10, 11, 13, 9, 12, 11, 9, 9, 11, 10, 8, 10, 11, 9, 12, 11, 9, 11, 9, 8, 11, 11, 10, 10, 9, 11, 9, 10, 9, 10, 10, 10, 9, 11, 11, 8, 9, 11, 8, 11, 10, 11, 10, 13, 10, 9, 9, 12, 9, 9, 10, 11, 10, 9, 10, 11, 10, 10, 11, 10, 9, 10, 9, 10, 10, 8, 8, 9, 10, 10, 9, 10]
    print(sequence)
    initial = random.sample(range(1, n+1), k)  # [1, 3, 11]#[6, 10, 17]  # 
    initial.sort()
    initial_configuration = list(initial)
    print("First ", initial_configuration)
    test = VirtualDoubleCoverage(n, k, initial)
    # print(test.configuration)
    vCost = 0
    pCost = 0
    for r in sequence:
        p, v = test.processRequest(r)
        print("-------------------------------------------------------")
        print("Physical configurations: ", test.configuration)
        print("Virtual configurations: ", test.vPosition)
        print("Virtual distance : ", test.vDistance)
        print("Virtual cost: ", v, " Physical cost: ", p)
        print("-------------------------------------------------------\n")
        vCost += v
        pCost += p
    # print(vCost, pCost)
    opt = ServerSpace(metric)
    # print("Second",initial_configuration)
    opt.add_servers(initial_configuration)
    print(opt.servers)
    optimal_cost = opt.process_requests(sequence)[0]
    # print("Total physical cost: ", pCost)
    print("Total virtual cost: ", vCost)
    print("Optimal cost: ", optimal_cost)
    print("(Virtual ) Competitive ratio: ", 1 if vCost ==
          optimal_cost else vCost/optimal_cost)
    print("(Physical ) Competitive ratio: ", 1 if pCost ==
          optimal_cost else pCost/optimal_cost)
    print()
    li = [n, k, vCost, pCost, optimal_cost, vCost/optimal_cost,
          pCost/optimal_cost, len(sequence), sequence]

    with open('badtestcases.csv', 'a') as csvfile:
        csvwriter = writer(csvfile)
        # csvwriter.writerow(fields)
        csvwriter.writerow(li)
        csvfile.close()
    print(len(sequence))
# print(sequence.count(10))
# print(sequence.count(9))
# print(sequence.count(8))
# print(sequence.count(11))
# print(sequence.count(12))


#[11, 9, 13, 9, 9, 10, 13, 10, 8, 11, 10, 9, 10, 11, 10, 10, 10, 10, 9, 10, 10, 9, 9, 11, 10, 12, 10, 8, 9, 11, 11, 10, 9, 11, 10, 12, 9, 10, 10, 11, 10, 10, 10, 10, 8, 10, 10, 11, 9, 10, 10, 9, 10, 12, 9, 10, 9, 10, 10, 11, 11, 11, 11, 10, 9, 10, 11, 11, 10, 11, 10, 11, 12, 10, 10, 9, 10, 10, 11, 10, 10, 11, 9, 9, 8, 8, 10, 10, 11, 10, 8, 11, 10, 11, 10, 9, 8, 10, 8, 9, 10, 9, 10, 10, 11, 10, 11, 9, 9, 11, 13, 9, 11, 11, 10, 9, 9, 9, 10, 11, 9, 11, 10, 9, 8, 10, 9, 11, 11, 11, 9, 11, 9, 11, 12, 10, 11, 10, 10, 11, 12, 11, 11, 11, 9, 11, 9, 9, 10, 11]
#[5, 8, 10, 12, 14]
